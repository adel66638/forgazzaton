<script>
    // إعدادات قاعدة البيانات (تأكد من وضع إعداداتك هنا)
    const firebaseConfig = {
        apiKey: "AIzaSyA4oGEMOmaraubqk8oS...", 
        authDomain: "ff-fortone.firebaseapp.com",
        databaseURL: "https://ff-fortone-default-rtdb.firebaseio.com",
        projectId: "ff-fortone",
        storageBucket: "ff-fortone.appspot.com",
        messagingSenderId: "890615410300",
        appId: "1:890615410300:web:5659f9..."
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
        manifestUrl: 'https://forgazzaton.vercel.app/tonconnect-manifest.json',
        buttonRootId: 'ton-connect-btn'
    });

    // مراقبة الحالة وفحص قاعدة البيانات فور الاتصال
    tonConnectUI.onStatusChange(async (wallet) => {
        const btnText = document.getElementById('buttonText');
        if (wallet) {
            const address = wallet.account.address;
            
            // فحص حالة المستخدم في Firebase
            const snapshot = await database.ref('users/' + address).once('value');
            if (snapshot.exists() && snapshot.val().level >= 1) {
                btnText.innerText = "Open Dashboard";
                // توجيه تلقائي إذا كان نشطاً
                window.location.href = 'dashboard.html';
            } else {
                btnText.innerText = "Pay 1 TON to Join";
            }
        } else {
            btnText.innerText = "Connect Wallet";
        }
    });

    async function handleMainAction() {
        if (!tonConnectUI.connected) {
            await tonConnectUI.openModal();
            return;
        }

        const address = tonConnectUI.wallet.account.address;

        // فحص أخير قبل الدفع
        const snapshot = await database.ref('users/' + address).once('value');
        if (snapshot.exists() && snapshot.val().level >= 1) {
            window.location.href = 'dashboard.html';
            return;
        }

        const transaction = {
            validUntil: Math.floor(Date.now() / 1000) + 360,
            messages: [{
                address: "UQBufh6lLHE5H1NDJXQwRIVCX-t4iKHyyoXD0Spm8N9navPx",
                amount: "1000000000" 
            }]
        };

        try {
            const result = await tonConnectUI.sendTransaction(transaction);
            if (result) {
                // تسجيل المستخدم في Firebase فور نجاح الدفع
                let numericString = "";
                for (let i = 0; i < address.length; i++) { numericString += address.charCodeAt(i).toString(); }
                let finalId = numericString.slice(-6);

                await database.ref('users/' + address).set({
                    wallet: address,
                    myId: finalId,
                    upline: new URLSearchParams(window.location.search).get('ref') || "none",
                    level: 1,
                    earnings: 0.2
                });

                window.location.href = 'dashboard.html';
            }
        } catch (e) {
            alert("Payment Canceled or Failed");
        }
    }
</script>
