<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FF FORTONE | Master Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <style>
        body { 
            background-color: #010413; 
            color: white; 
            font-family: 'Inter', sans-serif; 
            scroll-behavior: smooth; 
        }
        .glass { 
            background: rgba(255, 255, 255, 0.02); 
            backdrop-filter: blur(12px); 
            border: 1px solid rgba(255, 255, 255, 0.08); 
        }
        .active-level { 
            border-color: rgba(34, 197, 94, 0.4); 
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.1); 
        }
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: #2563eb; border-radius: 10px; }
        .admin-card { 
            background: linear-gradient(145deg, rgba(88, 28, 135, 0.15), rgba(15, 23, 42, 0.5)); 
            border: 1px solid rgba(168, 85, 247, 0.2); 
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }
        .floating { animation: float 3s ease-in-out infinite; }
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        .shimmer-effect {
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            background-size: 1000px 100%;
            animation: shimmer 2s infinite;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Navigation -->
    <nav class="flex justify-between items-center mb-10 max-w-7xl mx-auto">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl flex items-center justify-center">
                <span class="text-xl font-black">F</span>
            </div>
            <h1 class="text-3xl font-black italic uppercase tracking-tighter">FF <span class="text-blue-500">FORTONE</span></h1>
        </div>
        <div id="ton-connect-btn" class="floating"></div>
    </nav>

    <!-- Stats Section -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 max-w-7xl mx-auto mb-6">
        <!-- User Card -->
        <div class="glass p-6 rounded-[2.5rem] border-t-2 border-blue-600">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <p class="text-gray-500 text-[10px] uppercase font-black tracking-widest mb-1">Your ID</p>
                    <p id="user-id" class="text-2xl font-black italic">#------</p>
                </div>
                <button onclick="copyRef()" class="bg-blue-600 hover:bg-blue-500 text-white text-[9px] font-black px-4 py-2 rounded-xl transition-all active:scale-95 shadow-lg shadow-blue-500/20">
                    COPY LINK
                </button>
            </div>
            
            <div class="bg-black/40 p-3 rounded-2xl border border-white/5 mb-4">
                <p class="text-[8px] text-gray-500 uppercase font-bold mb-1">Your Referral Link</p>
                <p id="ref-link-display" class="text-[10px] font-mono text-blue-400 break-all">Connect wallet to see link...</p>
            </div>

            <div class="pt-2 border-t border-white/5">
                <p class="text-gray-600 text-[9px] uppercase font-bold">Upline ID</p>
                <p id="upline-id" class="text-sm font-bold text-blue-400">#------</p>
            </div>
        </div>
        
        <!-- Team Stats -->
        <div onclick="openReferralList()" class="glass p-6 rounded-[2.5rem] border-t-2 border-green-500 cursor-pointer hover:bg-white/5 transition-all transform active:scale-95">
            <p class="text-gray-500 text-[10px] uppercase font-black tracking-widest mb-1">Team (Direct / Indirect)</p>
            <div class="flex items-baseline gap-2">
                <p id="direct-refs" class="text-2xl font-black italic text-green-500">0</p>
                <span class="text-gray-600 text-xs">Direct</span>
                <span class="text-gray-700 mx-1">/</span>
                <p id="indirect-refs" class="text-xl font-black italic text-gray-400">0</p>
            </div>
            <p class="text-[9px] text-gray-500 mt-2 uppercase font-bold italic tracking-tighter">View Your Network Wallets</p>
        </div>

        <!-- Instant Earnings -->
        <div class="glass p-6 rounded-[2.5rem] border-t-2 border-yellow-500 shimmer-effect">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <p class="text-gray-500 text-[10px] uppercase font-black tracking-widest">Instant Earnings</p>
                    <p id="available-balance" class="text-2xl font-black italic text-yellow-500">0 TON</p>
                </div>
                <button onclick="withdrawInstant()" class="bg-yellow-600 hover:bg-yellow-500 text-white text-[9px] font-black px-5 py-2.5 rounded-xl transition-all active:scale-95 shadow-lg shadow-yellow-500/20">
                    WITHDRAW
                </button>
            </div>
            
            <div class="space-y-3">
                <div class="flex justify-between text-[9px]">
                    <span class="text-gray-500">Today's Earnings</span>
                    <span id="today-earnings" class="text-green-400 font-black">0 TON</span>
                </div>
                <div class="flex justify-between text-[9px]">
                    <span class="text-gray-500">Total Commissions</span>
                    <span id="total-commissions" class="text-blue-400 font-black">0 TON</span>
                </div>
                <div class="flex justify-between text-[9px]">
                    <span class="text-gray-500">Last Commission</span>
                    <span id="last-commission" class="text-purple-400 font-black">--:--</span>
                </div>
            </div>
        </div>

        <!-- Payment System -->
        <div class="glass p-6 rounded-[2.5rem] border-t-2 border-purple-500">
            <p class="text-gray-500 text-[10px] uppercase font-black tracking-widest mb-3">Payment System</p>
            <div class="space-y-3">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-full bg-green-500"></div>
                        <p class="text-[9px] text-gray-300">Project</p>
                    </div>
                    <p class="text-[9px] font-black text-green-400">50%</p>
                </div>
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-full bg-blue-500"></div>
                        <p class="text-[9px] text-gray-300">Upline</p>
                    </div>
                    <p class="text-[9px] font-black text-blue-400">50%</p>
                </div>
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-full bg-purple-500"></div>
                        <p class="text-[9px] text-gray-300">Speed</p>
                    </div>
                    <p class="text-[9px] font-black text-purple-400">Instant</p>
                </div>
            </div>
            <p id="payment-status" class="text-[8px] text-gray-600 mt-4 text-center">⚡ Real-time payments</p>
        </div>
    </div>

    <!-- Referrals Modal -->
    <div id="referral-modal" class="fixed inset-0 bg-black/90 backdrop-blur-xl z-50 hidden flex items-center justify-center p-4">
        <div class="glass w-full max-w-md rounded-[2.5rem] border-t-2 border-green-500 overflow-hidden">
            <div class="p-6 border-b border-white/5 flex justify-between items-center bg-white/5">
                <h3 class="text-xl font-black italic uppercase">Partner <span class="text-green-500">Wallets</span></h3>
                <button onclick="toggleModal(false)" class="text-gray-500 hover:text-white text-3xl">&times;</button>
            </div>
            <div id="referrals-container" class="p-6 max-h-[60vh] overflow-y-auto space-y-3"></div>
            <div class="p-4 bg-white/5 text-center">
                <button onclick="toggleModal(false)" class="text-[10px] font-black uppercase text-gray-400">Close</button>
            </div>
        </div>
    </div>

    <!-- Levels Grid -->
    <div class="max-w-7xl mx-auto mb-20">
        <h2 class="text-sm font-black uppercase tracking-[0.3em] mb-8 text-center text-gray-500">Marketing Grid</h2>
        <div id="levels-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
    </div>

    <!-- Admin Section -->
    <div id="admin-section" class="max-w-7xl mx-auto mb-20 hidden">
        <div class="glass p-8 rounded-[3rem] border-t-4 border-purple-600 bg-purple-900/10">
            <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                <div>
                    <h2 class="text-2xl font-black uppercase italic text-purple-500 tracking-tighter">Owner Database</h2>
                    <p class="text-[9px] text-gray-500 font-bold uppercase tracking-widest">Full Network Oversight</p>
                </div>
                <input type="text" id="admin-search" onkeyup="filterAdminList()" placeholder="Search ID or Wallet..." 
                    class="w-full md:w-80 bg-black/50 border border-white/10 rounded-2xl px-5 py-3 text-xs focus:border-purple-500 outline-none">
            </div>
            <div id="admin-data-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="max-w-7xl mx-auto mt-20 pt-8 border-t border-white/5 text-center">
        <p class="text-[8px] text-gray-600 uppercase font-black tracking-widest">FF FORTONE • INSTANT 50/50 PAYMENTS</p>
        <p class="text-[7px] text-gray-700 mt-2">Auto-distribution system | Powered by TON Blockchain</p>
    </footer>

    <script>
        // ==================== إعدادات Firebase ====================
        const firebaseConfig = {
            apiKey: "AIzaSyA4oGEMOmaraubqk8oS...", // ضع مفتاحك هنا
            authDomain: "ff-fortone.firebaseapp.com",
            databaseURL: "https://ff-fortone-default-rtdb.firebaseio.com",
            projectId: "ff-fortone",
            storageBucket: "ff-fortone.appspot.com",
            messagingSenderId: "890615410300",
            appId: "1:890615410300:web:5659f9..." // ضع App ID هنا
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // ==================== إعدادات النظام ====================
        const MY_ADMIN_ID = "555497"; 
        const PROJECT_WALLET = "UQBufh6lLHE5H1NDJXQwRIVCX-t4iKHyyoXD0Spm8N9navPx";
        const COMMISSION_PERCENTAGE = 50; // 50% للمحيل
        const LEVEL_PRICES = [0, 1, 2, 3, 4, 5, 7, 10, 12, 15, 20, 25, 30, 40, 50, 60, 80, 100, 120, 150, 200];

        // ==================== إعداد TON Connect ====================
        const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
            manifestUrl: 'https://forgazzaton.vercel.app/tonconnect-manifest.json',
            buttonRootId: 'ton-connect-btn'
        });

        // ==================== متغيرات النظام ====================
        let currentUserAddress = null;

        // ==================== الأحداث الرئيسية ====================
        tonConnectUI.onStatusChange(async (wallet) => {
            if (wallet) { 
                currentUserAddress = wallet.account.address;
                await loadUserData(currentUserAddress);
                document.getElementById('payment-status').textContent = "✅ Wallet Connected";
                document.getElementById('payment-status').className = "text-[8px] text-green-400 mt-4 text-center";
            } else { 
                window.location.href = 'index.html'; 
            }
        });

        // ==================== تحميل بيانات المستخدم ====================
        async function loadUserData(address) {
            database.ref('users/' + address).on('value', async (snap) => {
                const userData = snap.val();
                if (!userData) return;

                const myId = String(userData.myId || "");

                // تحديث بيانات الواجهة
                document.getElementById('user-id').innerText = "#" + myId;
                document.getElementById('upline-id').innerText = "#" + (userData.upline || "None");
                
                // توليد وعرض رابط الإحالة
                const refLink = window.location.origin + "/index.html?ref=" + myId;
                document.getElementById('ref-link-display').innerText = refLink;

                // تحديث بيانات العمولات الفورية
                await updateInstantEarnings(address);

                // تفعيل لوحة الأدمن إذا كان المستخدم هو صاحب الصلاحية
                if (myId === MY_ADMIN_ID) {
                    document.getElementById('admin-section').classList.remove('hidden');
                    loadAllUsersForAdmin();
                }

                // حساب عدد المباشرين
                const directQuery = await database.ref('users').orderByChild('upline').equalTo(myId).once('value');
                document.getElementById('direct-refs').innerText = directQuery.numChildren();

                // الاستماع للإشعارات الفورية
                listenForNotifications(address);

                renderLevels(userData.level, address);
            });
        }

        // ==================== وظائف النسخ ====================
        function copyRef() {
            const link = document.getElementById('ref-link-display').innerText;
            if (link.includes("...")) {
                showNotification("❌ Connect your wallet first!", "red");
                return;
            }
            
            navigator.clipboard.writeText(link).then(() => {
                showNotification("✅ Link copied to clipboard!", "green");
            }).catch(err => {
                console.error('Error copying link', err);
                showNotification("❌ Failed to copy link", "red");
            });
        }

        // ==================== وظائف المودال ====================
        function toggleModal(show) { 
            const modal = document.getElementById('referral-modal');
            modal.classList.toggle('hidden', !show);
            if (show) {
                modal.classList.add('flex');
                modal.classList.remove('hidden');
            }
        }

        async function openReferralList() {
            toggleModal(true);
            const container = document.getElementById('referrals-container');
            const myId = document.getElementById('user-id').innerText.replace('#', '');
            container.innerHTML = '<p class="text-center text-gray-600 animate-pulse text-[10px]">LOADING TEAM WALLETS...</p>';

            try {
                const snap = await database.ref('users').orderByChild('upline').equalTo(myId).once('value');
                if (snap.exists()) {
                    let html = '';
                    const data = snap.val();
                    for (let wallet in data) {
                        html += `
                            <div class="bg-white/5 p-4 rounded-2xl border border-white/5 hover:border-green-500/30 transition-all">
                                <p class="text-xs font-black text-green-400 mb-1">#${data[wallet].myId}</p>
                                <p class="text-[8px] font-mono text-blue-300 break-all">${wallet}</p>
                                <div class="flex justify-between items-center mt-2">
                                    <span class="text-[7px] text-gray-500">Level: ${data[wallet].level || 1}</span>
                                    <span class="text-[7px] text-green-400">Earned: ${(data[wallet].earnedFrom || 0).toFixed(2)} TON</span>
                                </div>
                            </div>`;
                    }
                    container.innerHTML = html;
                } else { 
                    container.innerHTML = '<p class="text-center py-10 text-gray-700">No Partners Yet</p>'; 
                }
            } catch (e) { 
                console.error(e); 
                container.innerHTML = '<p class="text-center py-10 text-red-500">Error loading data</p>';
            }
        }

        // ==================== نظام الترقية الفوري ====================
        async function upgradeLevel(level, price, address) {
            try {
                // الحصول على بيانات المستخدم والمحيل
                const userSnap = await database.ref('users/' + address).once('value');
                const userData = userSnap.val();
                const uplineId = userData.upline;
                
                // حساب المبالغ
                const totalAmount = (level === 1 ? 0.8 : price);
                const totalAmountNano = Math.floor(totalAmount * 1e9);
                const commissionNano = Math.floor((totalAmountNano * COMMISSION_PERCENTAGE) / 100);
                const projectNano = totalAmountNano - commissionNano;
                
                // تحضير المعاملة الفورية
                const messages = [];
                
                // جزء المشروع
                messages.push({
                    address: PROJECT_WALLET,
                    amount: projectNano.toString()
                });
                
                // جزء المحيل (إذا وجد)
                let uplineWallet = null;
                if (uplineId && uplineId !== "None" && uplineId !== "none") {
                    uplineWallet = await getUplineWallet(uplineId);
                    if (uplineWallet) {
                        messages.push({
                            address: uplineWallet,
                            amount: commissionNano.toString()
                        });
                    }
                }
                
                // إظهار تأكيد
                const confirmMessage = `
                    ⚡ Upgrade to Level ${level}?
                    
                    Total: ${totalAmount} TON
                    • Project: ${(projectNano/1e9).toFixed(2)} TON
                    ${uplineWallet ? `• Upline: ${(commissionNano/1e9).toFixed(2)} TON\n` : ''}
                    Confirm transaction?
                `;
                
                if (confirm(confirmMessage)) {
                    const transaction = {
                        validUntil: Math.floor(Date.now() / 1000) + 60,
                        messages: messages
                    };
                    
                    // تحديث حالة الدفع
                    updatePaymentStatus("⏳ Processing transaction...", "yellow");
                    
                    const result = await tonConnectUI.sendTransaction(transaction);
                    
                    if (result) {
                        // تحديث فوري في قاعدة البيانات
                        await database.ref('users/' + address).update({ 
                            level: level,
                            lastUpgrade: Date.now()
                        });
                        
    
