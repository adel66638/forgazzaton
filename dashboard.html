            if (!wallet) return;
            const address = wallet.account.address;
            const snap = await database.ref('users/' + address).once('value');
            const earnings = snap.val().earnings || 0;
            if (earnings < 0.1) return alert("Minimum 0.1 TON");
            alert(`طلب سحب بقيمة ${earnings.toFixed(2)} TON قيد المعالجة`);
            await database.ref('users/' + address).update({ earnings: 0 });
        }

        function renderLevels(address) {
            const grid = document.getElementById('levelsGrid');
            database.ref('users/' + address).on('value', (snapshot) => {
                const userData = snapshot.val();
                const userLvl = userData ? (userData.level || 0) : 0;
                grid.innerHTML = "";
                for (let i = 1; i <= 20; i++) {
                    let price = LEVEL_PRICES[i]; 
                    let isActive = i <= userLvl;
                    grid.innerHTML += `<div class="glass p-6 rounded-[2rem] text-center border ${isActive ? 'border-green-500/30' : 'border-white/5'}">
                        <p class="text-[8px] font-black text-blue-500 mb-2 uppercase italic">Level ${i}</p>
                        <p class="text-2xl font-black italic mb-6">${price} <span class="text-[10px] text-gray-500">TON</span></p>
                        <button onclick="upgradeLevel(${i}, ${price}, '${address}')" class="w-full py-3 rounded-xl text-[9px] font-black uppercase ${isActive ? 'bg-green-600/10 text-green-500' : 'bg-blue-600'}" ${isActive ? 'disabled' : ''}>${isActive ? 'Active' : 'Upgrade'}</button>
                    </div>`;
                }
            });
        }
        function closeWelcomeModal() { document.getElementById('welcome-modal').classList.add('hidden'); }
        function copyRef() { const c = document.getElementById("ref-link"); c.select(); document.execCommand("copy"); alert("Copied!"); }
        tonConnectUI.onStatusChange(wallet => {
            if (wallet) { setupReferralAndTrack(wallet.account.address); renderLevels(wallet.account.address); }
            else { window.location.href = 'index.html'; }
        });
    </script>
</body>
</html>
