<script>
    const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
        manifestUrl: 'https://forgazzaton.vercel.app/tonconnect-manifest.json',
        buttonRootId: 'ton-connect-main'
    });

    // هذه الدالة هي القفل الحقيقي
    async function checkAccess() {
        const wallet = tonConnectUI.wallet;
        
        // 1. إذا لم تكن المحفظة متصلة أصلاً
        if (!wallet) {
            document.getElementById('gatekeeper').style.display = 'flex';
            document.getElementById('dashboardContent').style.display = 'none';
            return;
        }

        const address = wallet.account.address;
        // 2. الفحص: هل هذا العنوان لديه "مفتاح تفعيل" في هذا المتصفح؟
        const isActive = localStorage.getItem('user_is_active_' + address);

        if (isActive === 'true') {
            // الشخص دفع فعلياً -> افتح له الموقع
            document.getElementById('gatekeeper').style.display = 'none';
            document.getElementById('dashboardContent').style.display = 'block';
        } else {
            // الشخص لم يدفع -> اطرده فوراً لصفحة الدفع
            alert("This area is for active members only. Please activate your account first.");
            window.location.href = 'index.html';
        }
    }

    // فحص الحالة فور تغير اتصال المحفظة
    tonConnectUI.onStatusChange(wallet => {
        checkAccess();
    });

    // فحص أولي عند تحميل الصفحة
    window.onload = checkAccess;

    // كود المستويات (عملك السابق)
    const grid = document.getElementById('levelsGrid');
    for (let i = 1; i <= 20; i++) {
        let price = i === 1 ? 1 : (i - 1) * 2;
        grid.innerHTML += `
            <div class="glass p-6 rounded-[2rem] text-center border border-white/5 relative">
                <span class="absolute top-4 right-4 text-[8px] font-black text-blue-500 italic uppercase">LVL ${i}</span>
                <img src="https://cryptologos.cc/logos/toncoin-ton-logo.svg?v=035" class="w-8 h-8 mx-auto mb-4 opacity-20">
                <p class="text-xl font-black italic mb-4 tracking-tighter">${price} TON</p>
                <button class="w-full py-2 rounded-xl text-[10px] font-[900] ${i===1?'bg-green-600/20 text-green-400':'bg-blue-600 hover:bg-blue-500 uppercase italic'}">
                    ${i===1?'ACTIVE':'UPGRADE'}
                </button>
            </div>
        `;
    }
</script>
